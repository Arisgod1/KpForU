# KpForU

KpForU 是一款由**手机 + 手表 + 云端 AI**协同的学习应用，目标是帮助用户在碎片化场景下保持持续专注、规律复习，并长期养成学习习惯。

- 手机端：Flutter（重交互：卡片管理、数据总览、查看 AI 总结）
- 手表端：原生 Android 11（轻交互：专注计时、提醒确认、快速录音）
- 后端：FastAPI + PostgreSQL（数据存储/同步、复习计划规则算法、AI 总结生成、语音转写接入）

---

## 1. 核心功能

## 1.1 专注计时：自定义“时间流”（可循环）
**时间流（Time Flow）**由多个阶段（Phase）组成，阶段类型包括：学习 / 休息 / 长休。

### 功能点
- 预设模板：25/5、45/10、60/10。
- 支持自定义：
  - 可添加多个阶段（学习/休息/长休）并保存为模板。
  - 支持循环 N 次，或运行到指定结束时间（例如“到 22:30 结束”）。
- 提醒方式：
  - 阶段切换提醒：震动 + 全屏提示（学习开始/休息开始）。
  - 可选“定时震动”：在学习阶段按固定间隔震动，适用于严重分心用户。
- 手表端交互保持极简：
  - 开始 / 暂停
  - 跳过当前阶段（立即切换到下一阶段）
  - 结束本次专注

### 后台可靠运行（Android 11）
- 手表端专注计时由**前台服务（Foreground Service）**承载，以确保：
  - 熄屏/切后台仍能持续计时
  - 到点震动与提醒可靠触发
  - 系统回收压力下仍保持稳定

### 数据记录与上传
- 每次时间流结束时（自然结束或用户提前结束）生成一条专注记录，并上传至云端。
- 专注记录至少包含：
  - 时间流配置快照（当次使用的阶段列表与循环/截止设置）
  - 实际开始时间、实际结束时间
  - 是否提前结束、结束时所处阶段
- 用户可设置：是否需要“手动确认保存”（默认可自动保存）。

---

## 1.2 复习提醒中心：只看“下一次复习/今日卡片数”
复习系统采用“手机端管理 + 云端规则计划 + 手表端提醒确认”的分工方式。

### 卡片创建与编辑（两种方式）
1) **手机端手动管理**
- 用户可增删改卡片内容（正面/背面/标签等），上传云端。

2) **手表端语音录入（轻量创建）**
- 手表端录音并保存为本地音频文件（如 mp3）。
- 上传到后端（采用**文件上传**，上传后即删除）。
- 后端调用语音转写模型（通义千问语音能力）将转写结果写入数据库，并生成卡片草稿供手机端二次编辑确认。

> 说明：手表端只做“快速采集”，卡片精修与整理在手机端完成，以控制手表端复杂度与适配成本。

### 复习计划（固定规则算法）
- 云端使用**固定规则算法**生成复习计划（例如简化 SM-2 / Leitner），不由 AI 直接调度。
- 云端产出关键指标供手表端展示：
  - 今日复习卡片数（已完成/计划，或至少已完成数）
  - 下一次复习时间（时间点或倒计时）
  - 单张卡片状态：`done` 或 `N days later`（或直接显示下次复习时间）

### 手表端到点提醒交互
- “已完成”：手表端上报一次完成事件，云端更新该卡片下次复习时间。
- “稍后”：延后 1/2/3 天（三个固定选项），云端顺延并更新计划。

---

## 1.3 AI 状态总结（只做总结与建议）
AI 不参与复习计划计算，只基于云端数据生成“文字总结 + 可执行建议”。

### 输入
- 专注记录（时长、提前结束等）
- 复习数据（完成数、延后次数等）

### 输出
- 今日/本周总结：专注执行情况、复习完成情况。
- 建议：给出可落地的设置建议，例如：
  - 若频繁提前结束，建议缩短学习段并尝试 25/5 等更易坚持节奏；
  - 若多次延后复习，建议降低每日复习量或拆分为更短的微任务。

---

## 2. 系统架构与分工

### 2.1 手机端（Flutter）
- 时间流模板配置与管理
- 卡片管理（增删改、整理、查看到期列表）
- 数据总览（专注/复习统计）
- 查看 AI 总结与建议

### 2.2 手表端（Android 11 原生）
- 专注计时（前台服务）
- 阶段切换提醒、可选定时震动
- 复习提醒确认（已完成/稍后）
- 语音录入（生成卡片草稿）

### 2.3 云端（FastAPI + PostgreSQL）
- 设备绑定与鉴权
- 数据存储与同步（专注记录、卡片、复习状态、事件）
- 复习计划规则算法（固定规则）
- AI 总结生成接口
- 语音转写接入（将录音转文本并生成卡片草稿）

---

## 3. 设备绑定与鉴权（简化、边界清晰）
### 3.1 绑定流程（一次性）
1) 手表端首次启动生成随机“绑定码”，上传云端（绑定码长期有效且不变）。
2) 手机端输入绑定码，云端建立“手机账号/手机设备”与“手表设备”的绑定关系。
3) 无需用户登录注册接口，极简流程。

### 3.2 后续鉴权（推荐标准 Token）
- 绑定完成后，手机端与手表端分别获取访问 Token（建议使用 Bearer Token/JWT）。
- 后续所有请求携带 `Authorization: Bearer <token>` 访问云端。
- 绑定码仅用于配对，不作为长期 Token 使用。

---

## 4. MVP 交付范围（保证现场可演示）
1) 手表端：时间流计时（开始/暂停/跳过/结束）+ 震动提醒 + 专注记录上传（前台服务）
2) 手机端：时间流模板配置 + 卡片创建/编辑 + 复习到期列表
3) 云端：卡片与专注记录存储 + 规则复习计划计算 + 手表端指标接口
4) AI：生成每日文字总结与建议（可作为增强功能）